name: Require Owner Approval
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted, edited, dismissed]

permissions:
  pull-requests: read
  contents: read
  statuses: write

jobs:
  owner-approval:
    name: Require owner approval
    runs-on: ubuntu-latest
    steps:
      - name: Check owner approval
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner.toLowerCase();
            const pr = context.payload.pull_request || (await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            })).data;

            const author = pr.user.login.toLowerCase();
            const headSha = pr.head.sha;

            // Helper to set commit status (ensures check appears on PR for review events)
            async function setStatus(state, description) {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: headSha,
                state: state,
                context: 'Require owner approval',
                description: description
              });
            }

            if (author === owner) {
              core.info(`PR author is repo owner (${owner}); passing.`);
              await setStatus('success', `PR author is repo owner`);
              return;
            }

            const reviews = await github.paginate(github.rest.pulls.listReviews, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100
            });

            const ownerApproved = reviews
              .filter(r => (r.user?.login || "").toLowerCase() === owner)
              .some(r => r.state === "APPROVED");

            if (!ownerApproved) {
              await setStatus('failure', `Missing approval from @${owner}`);
              core.setFailed(`Missing required approval from repo owner @${owner}.`);
            } else {
              await setStatus('success', `Approved by @${owner}`);
              core.info(`Owner @${owner} has approved.`);
            }
