name: Require Owner Approval
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted, edited, dismissed]

permissions:
  pull-requests: read
  contents: read
  statuses: write

jobs:
  owner-approval:
    name: Require owner approval
    runs-on: ubuntu-latest
    steps:
      - name: Check owner approval
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner.toLowerCase();
            const pr = context.payload.pull_request || (await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            })).data;

            const author = pr.user.login.toLowerCase();
            const headSha = pr.head.sha;

            async function setStatus(state, description) {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: headSha,
                state: state,
                context: 'Require owner approval',
                description: description
              });
            }

            // If owner authored the PR -> pass
            if (author === owner) {
              core.info(`PR author is repo owner (${owner}); passing.`);
              await setStatus('success', `PR author is repo owner`);
              return;
            }

            const reviews = await github.paginate(github.rest.pulls.listReviews, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100
            });

            // only count the latest review state per reviewer
            const latestByUser = new Map();
            for (const r of reviews) {
              const u = (r.user?.login || '').toLowerCase();
              if (!u) continue;
              const prev = latestByUser.get(u);
              if (!prev || new Date(r.submitted_at) > new Date(prev.submitted_at)) {
                latestByUser.set(u, r);
              }
            }

            const ownerReview = latestByUser.get(owner);
            const ownerApproved = ownerReview?.state === 'APPROVED';

            if (!ownerApproved) {
              await setStatus('failure', `Missing approval from @${owner}`);
              core.warning(`Missing required approval from repo owner @${owner}.`);
              return;
            }

            await setStatus('success', `Approved by @${owner}`);
            core.info(`Owner @${owner} has approved.`);
